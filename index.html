<!DOCTYPE html>
<html>
	<title>hello world</title>
	<head>
		<script src="/socket.io/socket.io.js"></script>
		<script src="http://code.jquery.com/jquery-1.9.0.min.js"></script>
		<script src="/Widgets-Loader.js"></script>
		
		<script src="/MIDI.js-master/js/MIDI/AudioDetect.js" type="text/javascript"></script>
	 	<script src="/MIDI.js-master/js/MIDI/LoadPlugin.js" type="text/javascript"></script>
		 <script src="MIDI.js-master/js/MIDI/Plugin.js" type="text/javascript"></script>
		 <script src="MIDI.js-master/js/MIDI/Player.js" type="text/javascript"></script>
		 <script src="MIDI.js-master/js/Window/DOMLoader.XMLHttp.js" type="text/javascript"></script>
		 <script src="MIDI.js-master/js/Window/DOMLoader.script.js" type="text/javascript"></script>
	 	<!-- extras -->
		 <script src="MIDI.js-master/inc/Base64.js" type="text/javascript"></script>
		 <script src="MIDI.js-master/inc/base64binary.js" type="text/javascript"></script>
	</head>
	<body>
		
		<div>
			<input type="button" id="button1" value="button 1">
			<input type="button" id="button2" value="button 2">
			<input type="button" id="button3" value="button 3">
		</div>
			
		<script>
				
		var socket = io.connect('http://localhost:8080');
		//var socket = io.connect('209.141.61.27');
		
		// MIDI variables
		var animationDur;
		var MIDIs;
		var playedKey;
		var midiObject;
		var start = false;
		var mystartTime;
		var nodeArray = new Array();
		var tracksArray = new Array();
		var myTrack=-1;
		var tracksNum=new Array();
		
		
		socket.emit("connect");
		socket.on('loadfile', function(song,thetracks) {
			// Begin loading indication.
			var loader = new widgets.Loader({
				message: "loading: Soundfont..."
			});
			tracksNum=thetracks;

			//Set up MIDI properties
			MIDI.loadPlugin({
				soundfontUrl: "MIDI.js-master/soundfont/",
				instruments: "acoustic_grand_piano",
				callback: function() {

					MIDI.programChange(0, 0);
					MIDI.programChange(1, 118);
					MIDIs = MIDI;
					//play();
				}
			});
			
			loader.message("Grabbing MIDI files ...");
			midiObject = song;
			
			socket.emit("ready");
			loader.stop();
			
		});
		
		socket.on("currenttime", function(time,track){
			mystartTime = time;
			//start = true;
			myTrack=track;
			
			play();
		});

		function play() {
			for(var i =0;i<tracksNum.length;i++){
				trackNo=tracksNum[i];
				time=0;
				var nodeArray=new Array();
				for ( n = 0; n < midiObject.track[trackNo].event.length - 1; n++) {
					//console.log("type:"+midiObject.track[trackNo].event[n].type);
					
					
					
					if (midiObject.track[trackNo].event[n].type == 8 || midiObject.track[trackNo].event[n].type == 9) {
						var note=midiObject.track[trackNo].event[n].data[0];
						nodeArray.push(note);
						var diff=time-mystartTime+animationDur;
						if(diff>0)
						setTimeout(function(){playNote(tracksArray[i].pop());},diff);
						time = time + midiObject.track[trackNo].event[n].deltaTime*(960/midiObject.timeDivision);
						
					}
					
					//console.log(time);
					//console.log(n);
					//console.log(t);
				}
				tracksArray.push(nodeArray);
			}	
		}
		
		function playNote (node,track) {
			var delay = 0;
			var note = node;
			console.log("note:"+note);
			var velocity = 127;
			
			//if(node.type == 8) {
				//MIDI.noteOff(0, note, delay);
			//} else {
				MIDIs.noteOn(0, note, velocity, delay);
			//}
		}
		

		
		/*
		$('#button1').click(function(){
			playedKey = 25;
			socket.emit('play', playedKey);
			play();
			console.log("Playing client tone");
		});
		
		$('#button2').click(function(){
			playedKey = 50;
			socket.emit('play', playedKey);
			play();
			console.log("Playing client tone");
		});
		
		$('#button3').click(function(){
			playedKey = 75;
			socket.emit('play', playedKey);
			play();
			console.log("Playing client tone");
		});
		*/
		/*
		socket.on('playnote', function(note){
			console.log("note is " + note);
			playedKey = note;
			play();
			console.log("Playing server tone");
		});*/

		</script>
	</body>
</html>